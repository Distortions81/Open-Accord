<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>{{.Title}}</title>
  <style>
    [hidden] { display:none !important; }
    :root { --bg:#0d1217; --panel:#151d25; --text:#e6edf3; --muted:#8e9aa7; --accent:#55b2ff; --line:#263341; }
    body { margin:0; font-family: ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; background:var(--bg); color:var(--text); }
    .wrap { width:100vw; height:100vh; margin:0; padding:10px; box-sizing:border-box; display:grid; grid-template-columns: minmax(280px, 320px) 1fr; gap:10px; }
    .mode-dm #friendList { border-color:#78c8ff; box-shadow:0 0 0 1px rgba(120,200,255,.22) inset; }
    .mode-group #groupList, .mode-group #channelList { border-color:#65d59c; box-shadow:0 0 0 1px rgba(101,213,156,.2) inset; }
    .panel { background:var(--panel); border:1px solid var(--line); border-radius:10px; padding:10px; display:flex; flex-direction:column; min-height:0; }
    .left-panel { position:relative; padding-bottom:56px; }
    .right-col { display:grid; grid-template-rows: minmax(140px, 34%) 1fr; gap:12px; min-height:0; }
    .friend-list { flex:1; min-height:0; overflow-y:auto; overflow-x:hidden; border:1px solid var(--line); border-radius:8px; padding:6px; }
    .group-list { max-height:20vh; overflow:auto; border:1px solid var(--line); border-radius:8px; padding:6px; }
    .channel-list { max-height:16vh; overflow:auto; border:1px solid var(--line); border-radius:8px; padding:6px; margin-top:6px; }
    .group-row { display:flex; align-items:center; gap:8px; justify-content:space-between; padding:6px 4px; border-bottom:1px solid #223040; cursor:pointer; }
    .group-name { min-width:0; overflow-wrap:anywhere; word-break:break-word; font-weight:700; flex:1; }
    .row-icon-btn {
      width:auto; min-width:0; margin:0; padding:2px 7px; border-radius:999px;
      border:1px solid #2d3c4b; background:#0f1620; color:#8e9aa7; cursor:pointer;
      line-height:1; font-weight:700;
    }
    .header-row { display:flex; align-items:center; justify-content:space-between; gap:8px; }
    .header-row h3 { margin:0; }
    .invite-editor {
      position:fixed; right:14px; bottom:14px; width:320px; z-index:1200;
      box-shadow:0 10px 28px rgba(0,0,0,.45);
      max-height:70vh;
    }
    .invite-list { max-height:32vh; overflow:auto; border:1px solid var(--line); border-radius:8px; padding:6px; margin:6px 0; }
    .chk-row { display:flex; align-items:center; gap:8px; padding:4px 2px; }
    .chk-row input { width:auto; margin:0; }
    .friend-row { border-radius:8px; transition:background-color .12s ease, box-shadow .12s ease; }
    .sel-row-dm {
      background:linear-gradient(90deg, rgba(55,139,214,.38), rgba(20,31,43,.82));
      box-shadow:inset 3px 0 0 #78c8ff, 0 0 0 1px rgba(120,200,255,.28);
    }
    .sel-row-group {
      background:linear-gradient(90deg, rgba(68,166,123,.35), rgba(20,31,43,.82));
      box-shadow:inset 3px 0 0 #65d59c, 0 0 0 1px rgba(101,213,156,.25);
    }
    .sel-row-channel {
      background:linear-gradient(90deg, rgba(191,149,67,.34), rgba(20,31,43,.82));
      box-shadow:inset 3px 0 0 #f0c46f, 0 0 0 1px rgba(240,196,111,.24);
    }
    h3 { margin:0 0 8px; font-size:12px; color:var(--muted); letter-spacing:.04em; text-transform:uppercase; }
    pre { margin:0; white-space:pre-wrap; word-wrap:break-word; overflow-wrap:anywhere; flex:1; min-height:0; overflow:auto; }
    input, textarea, button, select { width:100%; box-sizing:border-box; margin:4px 0; padding:7px 8px; border-radius:8px; border:1px solid #2d3c4b; background:#10171f; color:var(--text); }
    button { background: var(--accent); color:#001018; font-weight:700; cursor:pointer; border-color:transparent; }
    .row { display:flex; gap:8px; }
    .row > * { flex:1; }
    .small { font-size:12px; color:var(--muted); }
    .linkish { cursor:pointer; color:#8ecbff; text-decoration:underline; text-decoration-color:transparent; transition:text-decoration-color .15s; }
    .linkish:hover { text-decoration-color:#8ecbff; }
    #session { white-space: pre-wrap; overflow-wrap: anywhere; word-break: break-all; }
    #chatLog { flex:1; min-height:0; overflow:auto; border:1px solid var(--line); border-radius:8px; padding:6px; }
    .chat-row { padding: 2px 0; display:flex; gap:8px; align-items:baseline; }
    .chat-ts { color:var(--muted); font-size:12px; min-width:56px; }
    .chat-name { color:#8ecbff; cursor:pointer; font-weight:700; white-space:nowrap; }
    .chat-text { white-space:pre-wrap; overflow-wrap:anywhere; word-break:break-word; }
    .profile-card { position:fixed; right:14px; top:14px; width:320px; z-index:1000; box-shadow:0 10px 28px rgba(0,0,0,.45); }
    .profile-card .small { margin-bottom:6px; }
    .muted { color:var(--muted); }
    .id-copy-wrap { display:inline-flex; position:relative; align-items:center; }
    .copy-id-btn {
      width:auto; min-width:0; margin:0; padding:2px 4px; border-radius:5px;
      border:1px solid #33404d; background:#111820; color:#8ecbff; cursor:pointer;
      display:inline-flex; align-items:center; justify-content:center;
    }
    .copy-id-btn svg { width:11px; height:11px; fill:currentColor; }
    .copy-tip {
      position:absolute; bottom:calc(100% + 6px); right:0; left:auto; transform:none;
      background:#111820; border:1px solid #33404d; border-radius:4px; padding:2px 6px;
      color:var(--text); font-size:11px; white-space:nowrap; opacity:0; pointer-events:none; z-index:2000;
      transition:opacity .12s ease;
    }
    .id-copy-wrap:hover .copy-tip { opacity:1; }
    .friend-head { display:flex; align-items:center; justify-content:space-between; gap:8px; min-width:0; }
    .friend-head > .linkish { min-width:0; flex:1; overflow-wrap:anywhere; word-break:break-word; }
    .friend-name-wrap { display:flex; align-items:center; gap:6px; min-width:0; flex:1; }
    .friend-controls { display:inline-flex; align-items:center; gap:6px; }
    .unread-badge {
      display:inline-flex; align-items:center; justify-content:center;
      width:18px; height:18px; border-radius:50%;
      background:#d92b45; color:#fff; font-size:11px; font-weight:700; line-height:1;
    }
    .pending-head { margin-top:8px; padding-top:8px; border-top:1px solid #223040; font-size:11px; color:var(--muted); text-transform:uppercase; letter-spacing:.04em; }
    .pending-row { padding:6px 4px; border-bottom:1px solid #223040; }
    .pending-actions { display:flex; gap:6px; margin-top:4px; }
    .pending-actions button { margin:0; padding:5px 7px; width:auto; }
    .status-chip { font-size:11px; border:1px solid #33404d; border-radius:999px; padding:1px 8px; text-transform:lowercase; }
    .status-online { color:#59d185; border-color:#2b6e45; background:#10281a; }
    .status-offline { color:#c9a37f; border-color:#5a4430; background:#241a12; }
    .status-invisible { color:#9d90c4; border-color:#4e4568; background:#191628; }
    .status-unknown { color:#9aa6b2; border-color:#33404d; background:#141b22; }
    .profile-fab-wrap { position:absolute; left:10px; bottom:10px; z-index:4; display:inline-flex; align-items:center; }
    .profile-fab-stack { display:inline-flex; flex-direction:column; align-items:center; gap:4px; }
    .profile-fab {
      width:auto; min-width:0; margin:0; padding:6px; border-radius:999px;
      border:1px solid #33404d; background:#111820; color:#8ecbff; cursor:pointer;
      display:inline-flex; align-items:center; justify-content:center;
    }
    .profile-fab svg { width:15px; height:15px; fill:currentColor; }
    .profile-fab-tip {
      position:absolute; left:calc(100% + 8px); bottom:50%; transform:translateY(50%);
      background:#111820; border:1px solid #33404d; border-radius:4px; padding:2px 6px;
      color:var(--text); font-size:11px; white-space:nowrap; opacity:0; pointer-events:none;
      transition:opacity .12s ease;
    }
    .friends-user { color:var(--muted); font-size:11px; font-weight:400; text-transform:none; letter-spacing:0; margin-left:4px; }
    .profile-fab-wrap:hover .profile-fab-tip { opacity:1; }
    .profile-editor { position:absolute; left:10px; bottom:52px; width:286px; z-index:5; box-shadow:0 10px 28px rgba(0,0,0,.5); }
    .presence-fab {
      position:absolute; left:50%; bottom:10px; transform:translateX(-50%);
      width:auto; min-width:0; padding:6px; border-radius:999px;
      border:1px solid #33404d; background:#111820; color:#8ecbff;
      display:inline-flex; align-items:center; justify-content:center; z-index:4;
    }
    .presence-fab svg { width:15px; height:15px; fill:currentColor; }
    .presence-editor {
      position:absolute; left:50%; bottom:52px; transform:translateX(-50%);
      width:286px; z-index:5; box-shadow:0 10px 28px rgba(0,0,0,.5);
    }
    .friend-fab {
      position:absolute; right:10px; bottom:10px;
      width:auto; min-width:0; padding:6px 10px; border-radius:999px;
      border:1px solid #33404d; background:#111820; color:#8ecbff;
      font-weight:700; line-height:1; z-index:4;
    }
    .friend-editor {
      position:absolute; right:10px; bottom:52px; width:286px; z-index:5;
      box-shadow:0 10px 28px rgba(0,0,0,.5);
    }
    @media (max-width: 900px) {
      .wrap { height:auto; min-height:100vh; grid-template-columns: 1fr; }
      .profile-card { left:12px; right:12px; top:12px; width:auto; }
      .profile-editor { width:calc(100% - 20px); }
      .friend-editor { width:calc(100% - 20px); }
      .presence-editor { width:calc(100% - 20px); }
      .right-col { grid-template-rows: auto auto; }
    }
  </style>
</head>
<body>
<div id="mainWrap" class="wrap">
  <div class="panel left-panel">
    <h3 style="margin-top:12px">Friends: <span id="friendsUserName" class="friends-user"></span></h3>
    <div id="friendList" class="small friend-list"></div>
    <div class="header-row" style="margin-top:10px;">
      <h3>Servers</h3>
      <button id="serverCreateBtn" class="row-icon-btn" title="Create server/group" style="color:#8ecbff;">+</button>
    </div>
    <div id="groupList" class="small group-list"></div>
    <div class="header-row" style="margin-top:8px;">
      <h3>Channels</h3>
      <button id="channelCreateBtn" class="row-icon-btn" title="Create channel" style="color:#8ecbff;" hidden>+</button>
    </div>
    <div id="channelList" class="small channel-list"></div>

    <div id="profileEditor" class="panel profile-editor" hidden>
      <div class="row" style="align-items:center;">
        <h3 style="margin:0; flex:1;">Edit Profile</h3>
        <div id="profileIDCopy"></div>
        <button id="profileEditorClose" style="width:auto; padding:4px 8px;" title="Close">X</button>
      </div>
      <input id="displayName" placeholder="display name">
      <textarea id="profileText" rows="3" placeholder="profile text"></textarea>
      <button id="saveProfile">Save Profile</button>
    </div>
    <div id="presenceEditor" class="panel presence-editor" hidden>
      <div class="row" style="align-items:center;">
        <h3 style="margin:0; flex:1;">Presence</h3>
        <button id="presenceEditorClose" style="width:auto; padding:4px 8px;" title="Close">X</button>
      </div>
      <div class="row">
        <select id="presenceMode">
          <option value="visible">visible</option>
          <option value="invisible">invisible</option>
        </select>
        <input id="presenceTTL" type="number" min="180" max="900" step="30" placeholder="ttl sec">
      </div>
      <button id="presenceSave">Update Presence</button>
    </div>
    <div class="profile-fab-wrap">
      <div class="profile-fab-stack">
        <button id="profileFab" class="profile-fab" type="button" aria-label="profile">
          <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5zm0 2c-4.4 0-8 2-8 4.5V21h16v-2.5C20 16 16.4 14 12 14z"/></svg>
        </button>
      </div>
      <span class="profile-fab-tip">profile</span>
    </div>
    <button id="presenceFab" class="presence-fab" type="button" aria-label="presence" title="Presence settings">
      <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M19.4 13a7.8 7.8 0 0 0 .1-1l2-1.6-2-3.4-2.4 1a7.9 7.9 0 0 0-1.7-1l-.3-2.6h-4l-.3 2.6a7.9 7.9 0 0 0-1.7 1l-2.4-1-2 3.4L4.5 12a7.8 7.8 0 0 0 .1 1l-2 1.6 2 3.4 2.4-1a7.9 7.9 0 0 0 1.7 1l.3 2.6h4l.3-2.6a7.9 7.9 0 0 0 1.7-1l2.4 1 2-3.4-2-1.6zM12 15.2a3.2 3.2 0 1 1 0-6.4 3.2 3.2 0 0 1 0 6.4z"/></svg>
    </button>

    <button id="friendFab" class="friend-fab" type="button" aria-label="friends" title="Friend actions">+</button>
    <div id="friendEditor" class="panel friend-editor" hidden>
      <div class="row" style="align-items:center;">
        <h3 style="margin:0; flex:1;">Friend Actions</h3>
        <button id="friendEditorClose" style="width:auto; padding:4px 8px;" title="Close">X</button>
      </div>
      <input id="friendInput" placeholder="friend login_id (or known alias/nickname)">
      <div class="row">
        <button id="friendAdd">Friend Add</button>
      </div>
    </div>
  </div>

  <div class="right-col">
    <div class="panel">
      <h3>Info</h3>
      <pre id="info"></pre>
    </div>
    <div class="panel">
      <h3 id="chatTitle">Chat</h3>
      <div id="chatLog"></div>
      <textarea id="message" rows="4" placeholder="type message"></textarea>
      <div class="row">
        <button id="send">Send</button>
      </div>
    </div>
  </div>
</div>

<div id="profileCard" class="panel profile-card" hidden>
  <div class="row" style="align-items:center;">
    <h3 style="margin:0; flex:1;">Profile</h3>
    <button id="profileClose" style="width:auto; padding:4px 8px;" title="Close">X</button>
  </div>
  <div class="small muted">Nickname</div>
  <div id="cardNickname"></div>
  <div class="small muted" style="margin-top:8px;">Login ID</div>
  <div id="cardID" style="white-space:pre-wrap; overflow-wrap:anywhere;"></div>
  <div class="small muted" style="margin-top:8px;">Profile text</div>
  <div id="cardProfile" style="white-space:pre-wrap; overflow-wrap:anywhere;"></div>
  <div class="small muted" style="margin-top:8px;">Last refreshed</div>
  <div id="cardRefreshed"></div>
</div>

<div id="inviteEditor" class="panel invite-editor" hidden>
  <div class="row" style="align-items:center;">
    <h3 id="inviteTitle" style="margin:0; flex:1;">Invite</h3>
    <button id="inviteClose" style="width:auto; padding:4px 8px;" title="Close">X</button>
  </div>
  <div id="inviteList" class="invite-list small"></div>
  <button id="inviteSend">Send Invite</button>
</div>

<script>
let since = 0;
const infoEl = document.getElementById('info');
const chatEl = document.getElementById('chatLog');
const friendList = document.getElementById('friendList');
const groupList = document.getElementById('groupList');
const channelList = document.getElementById('channelList');
const chatTitle = document.getElementById('chatTitle');
const profileCard = document.getElementById('profileCard');
const cardNickname = document.getElementById('cardNickname');
const cardID = document.getElementById('cardID');
const cardProfile = document.getElementById('cardProfile');
const cardRefreshed = document.getElementById('cardRefreshed');
const profileEditor = document.getElementById('profileEditor');
const friendEditor = document.getElementById('friendEditor');
const presenceEditor = document.getElementById('presenceEditor');
const inviteEditor = document.getElementById('inviteEditor');
const mainWrap = document.getElementById('mainWrap');
const inviteTitle = document.getElementById('inviteTitle');
const inviteList = document.getElementById('inviteList');
const profileIDCopy = document.getElementById('profileIDCopy');
const friendsUserName = document.getElementById('friendsUserName');
const presenceMode = document.getElementById('presenceMode');
const presenceTTL = document.getElementById('presenceTTL');
document.getElementById('profileClose').onclick = () => { profileCard.hidden = true; };
document.getElementById('profileFab').onclick = () => { profileEditor.hidden = !profileEditor.hidden; };
document.getElementById('profileEditorClose').onclick = () => { profileEditor.hidden = true; };
document.getElementById('presenceFab').onclick = () => { presenceEditor.hidden = !presenceEditor.hidden; };
document.getElementById('presenceEditorClose').onclick = () => { presenceEditor.hidden = true; };
document.getElementById('friendFab').onclick = () => { friendEditor.hidden = !friendEditor.hidden; };
document.getElementById('friendEditorClose').onclick = () => { friendEditor.hidden = true; };
document.getElementById('inviteClose').onclick = () => { inviteEditor.hidden = true; };
let activeTarget = '';
let activeGroup = '';
let activeChannel = 'default';
let latestGroups = [];
let latestTargets = [];
let latestPendingFriends = [];
let inviteGroup = '';
let inviteChannel = '';
let persistContextTimer = null;
let selfLoginID = '';
let chatEvents = [];
let unreadDM = {};
let unreadGroupChannel = {};

function updateChatContext() {
  mainWrap.classList.remove('mode-dm', 'mode-group');
  if (activeGroup) {
    mainWrap.classList.add('mode-group');
    chatTitle.textContent = `${activeGroup}/${activeChannel}`;
  } else {
    mainWrap.classList.add('mode-dm');
    if (!activeTarget) {
      chatTitle.textContent = 'Select a friend to direct message';
      return;
    }
    const t = (latestTargets || []).find((x) => (x.id || '') === activeTarget);
    const label = (t && t.label) ? t.label : activeTarget;
    chatTitle.textContent = `${label} direct message`;
  }
  renderChat();
}

function appendInfo(line) {
  infoEl.textContent += line + "\n";
  const lines = infoEl.textContent.split("\n");
  if (lines.length > 500) infoEl.textContent = lines.slice(lines.length - 500).join("\n");
  infoEl.scrollTop = infoEl.scrollHeight;
}

function eventMatchesActiveContext(ev) {
  if (!ev || ev.kind !== 'chat') return false;
  const mode = (ev.mode || '').trim();
  if (activeGroup) {
    const ch = (ev.channel || 'default').trim() || 'default';
    return mode === 'group' && (ev.group || '') === activeGroup && ch === activeChannel;
  }
  if (activeTarget) {
    return mode === 'dm' && (ev.target || '') === activeTarget;
  }
  return false;
}

function renderChat() {
  chatEl.innerHTML = '';
  const visible = chatEvents.filter(eventMatchesActiveContext);
  for (const ev of visible) {
    const row = document.createElement('div');
    row.className = 'chat-row';
    const ts = document.createElement('span');
    ts.className = 'chat-ts';
    ts.textContent = ev.ts || '';
    const name = document.createElement('span');
    name.className = 'chat-name';
    name.textContent = ev.actor_label || 'unknown';
    if (ev.actor_id) {
      name.title = 'View profile';
      name.onclick = () => openProfileCard(ev.actor_id);
    } else {
      name.className = '';
    }
    const msg = document.createElement('span');
    msg.className = 'chat-text';
    msg.textContent = ev.text || '';
    row.appendChild(ts);
    row.appendChild(name);
    row.appendChild(msg);
    chatEl.appendChild(row);
  }
  while (chatEl.childElementCount > 500) {
    chatEl.removeChild(chatEl.firstChild);
  }
  chatEl.scrollTop = chatEl.scrollHeight;
}

function appendChat(ev) {
  chatEvents.push(ev);
  if (chatEvents.length > 1000) chatEvents = chatEvents.slice(chatEvents.length - 1000);
  const isDM = (ev.mode || '').trim() === 'dm';
  const isGroup = (ev.mode || '').trim() === 'group';
  const target = (ev.target || '').trim();
  const group = (ev.group || '').trim();
  const channel = ((ev.channel || 'default').trim() || 'default');
  if (isDM && target && target !== activeTarget && ev.actor_id !== selfLoginID) {
    unreadDM[target] = (unreadDM[target] || 0) + 1;
    renderTargets(latestTargets, latestPendingFriends);
  }
  if (isGroup && group && ev.actor_id !== selfLoginID) {
    const isActiveThread = !!activeGroup && activeGroup === group && (activeChannel || 'default') === channel;
    if (!isActiveThread) {
      const key = group + '/' + channel;
      unreadGroupChannel[key] = (unreadGroupChannel[key] || 0) + 1;
      renderGroups(latestGroups);
    }
  }
  if (eventMatchesActiveContext(ev)) {
    renderChat();
  }
}

function clearUnreadDM(target) {
  target = (target || '').trim();
  if (!target) return;
  if (unreadDM[target]) delete unreadDM[target];
}

function createUnreadBadge(count) {
  const b = document.createElement('span');
  b.className = 'unread-badge';
  b.textContent = count > 9 ? '9+' : String(count);
  return b;
}

function clearUnreadGroupChannel(group, channel) {
  group = (group || '').trim();
  channel = ((channel || 'default').trim() || 'default');
  if (!group) return;
  const key = group + '/' + channel;
  if (unreadGroupChannel[key]) delete unreadGroupChannel[key];
}

function unreadCountForGroup(group) {
  group = (group || '').trim();
  if (!group) return 0;
  const prefix = group + '/';
  let total = 0;
  for (const [k, n] of Object.entries(unreadGroupChannel)) {
    if (k.startsWith(prefix)) total += Number(n || 0);
  }
  return total;
}

function currentTarget() {
  return activeTarget;
}

function currentContextPayload() {
  if (activeGroup) {
    return {mode: 'group', group: activeGroup, channel: activeChannel || 'default'};
  }
  if (activeTarget) {
    return {mode: 'dm', target: activeTarget};
  }
  return {};
}

async function persistContextNow() {
  try {
    await post('/api/context/set', currentContextPayload());
  } catch (_) {}
}

function persistContextSoon() {
  if (persistContextTimer) clearTimeout(persistContextTimer);
  persistContextTimer = setTimeout(() => {
    persistContextTimer = null;
    persistContextNow();
  }, 120);
}

async function post(url, body) {
  const res = await fetch(url, {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(body || {})
  });
  const data = await res.json().catch(() => ({}));
  if (!res.ok) throw new Error(data.error || ('http ' + res.status));
  return data;
}

function relativeTime(unixSec) {
  if (!unixSec || unixSec <= 0) return 'unknown';
  const delta = Math.max(0, Math.floor(Date.now() / 1000) - unixSec);
  if (delta < 10) return 'just now';
  if (delta < 60) return `${delta}s ago`;
  const minutes = Math.floor(delta / 60);
  if (minutes < 60) return `${minutes}m ago`;
  const hours = Math.floor(minutes / 60);
  if (hours < 24) return `${hours}h ago`;
  const days = Math.floor(hours / 24);
  return `${days}d ago`;
}

function createCopyIDControl(loginID) {
  const wrap = document.createElement('span');
  wrap.className = 'id-copy-wrap';
  const tip = document.createElement('span');
  tip.className = 'copy-tip';
  tip.textContent = 'copyid';
  const btn = document.createElement('button');
  btn.className = 'copy-id-btn';
  btn.type = 'button';
  btn.setAttribute('aria-label', 'copyid');
  btn.innerHTML = '<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M16 1H6a2 2 0 0 0-2 2v12h2V3h10V1zm3 4H10a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h9a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2zm0 16H10V7h9v14z"/></svg>';
  let resetTimer = null;
  btn.onmouseenter = () => { tip.textContent = 'copyid'; };
  btn.onclick = async () => {
    if (!loginID) return;
    try {
      if (navigator.clipboard && navigator.clipboard.writeText) {
        await navigator.clipboard.writeText(loginID);
      } else {
        const ta = document.createElement('textarea');
        ta.value = loginID;
        ta.style.position = 'fixed';
        ta.style.opacity = '0';
        document.body.appendChild(ta);
        ta.focus();
        ta.select();
        document.execCommand('copy');
        document.body.removeChild(ta);
      }
      tip.textContent = 'copied!';
      if (resetTimer) clearTimeout(resetTimer);
      resetTimer = setTimeout(() => { tip.textContent = 'copyid'; }, 1200);
    } catch (_) {
      tip.textContent = 'copyid';
    }
  };
  wrap.appendChild(btn);
  wrap.appendChild(tip);
  return wrap;
}

function statusClass(status) {
  if (status === 'online') return 'status-chip status-online';
  if (status === 'offline') return 'status-chip status-offline';
  if (status === 'invisible') return 'status-chip status-invisible';
  return 'status-chip status-unknown';
}

async function openProfileCard(loginID) {
  if (!loginID) return;
  try {
    const res = await fetch('/api/profile/card?id=' + encodeURIComponent(loginID));
    const data = await res.json();
    if (!res.ok) throw new Error(data.error || ('http ' + res.status));
    const p = data.profile || {};
    cardNickname.textContent = p.nickname || p.label || '(unknown)';
    cardID.innerHTML = '';
    cardID.appendChild(createCopyIDControl(p.id || loginID));
    cardProfile.textContent = p.profile_text || '(empty)';
    cardRefreshed.textContent = relativeTime(p.last_refreshed || 0);
    profileCard.hidden = false;
  } catch (e) {
    appendInfo(`profile card failed: ${e.message}`);
  }
}

function renderTargets(targets, pendingFriends) {
  latestTargets = Array.isArray(targets) ? targets : [];
  latestPendingFriends = Array.isArray(pendingFriends) ? pendingFriends : [];
  let changed = false;
  if (!activeGroup && activeTarget) {
    const found = latestTargets.some((t) => (t.id || '') === activeTarget);
    if (!found) {
      activeTarget = '';
      changed = true;
    }
  }
  friendList.innerHTML = '';
  for (const t of latestTargets) {
    const row = document.createElement('div');
    row.className = 'friend-row';
    row.style.padding = '6px 4px';
    row.style.borderBottom = '1px solid #25303b';
    row.style.wordBreak = 'break-all';
    row.style.overflowWrap = 'anywhere';
    row.style.cursor = 'pointer';
    if (activeTarget === t.id && !activeGroup) row.classList.add('sel-row-dm');
    row.onclick = () => {
      clearUnreadDM(t.id);
      activeTarget = t.id;
      activeGroup = '';
      activeChannel = 'default';
      renderTargets(latestTargets, latestPendingFriends);
      updateChatContext();
      persistContextSoon();
    };

    const name = document.createElement('div');
    name.textContent = t.label;
    name.style.fontWeight = '700';
    name.style.minWidth = '0';
    name.style.flex = '1';
    name.style.overflowWrap = 'anywhere';
    name.style.wordBreak = 'break-word';
    const nameWrap = document.createElement('div');
    nameWrap.className = 'friend-name-wrap';
    nameWrap.appendChild(name);
    const unread = Number(unreadDM[t.id] || 0);
    if (unread > 0) {
      nameWrap.appendChild(createUnreadBadge(unread));
    }
    const status = document.createElement('span');
    const state = (t.online === 'online') ? 'online' : 'offline';
    status.textContent = state;
    status.className = statusClass(state);
    const controls = document.createElement('div');
    controls.className = 'friend-controls';
    const info = document.createElement('button');
    info.type = 'button';
    info.className = 'row-icon-btn';
    info.title = 'View profile';
    info.setAttribute('aria-label', 'View profile');
    info.textContent = 'i';
    info.onclick = (ev) => {
      ev.stopPropagation();
      openProfileCard(t.id);
    };
    controls.appendChild(info);
    controls.appendChild(status);
    controls.appendChild(createCopyIDControl(t.id));
    const head = document.createElement('div');
    head.className = 'friend-head';
    head.appendChild(nameWrap);
    head.appendChild(controls);

    row.appendChild(head);
    friendList.appendChild(row);
  }
  const pending = latestPendingFriends;
  if (pending.length > 0) {
    const header = document.createElement('div');
    header.className = 'pending-head';
    header.textContent = 'Pending Requests';
    friendList.appendChild(header);
    for (const p of pending) {
      const row = document.createElement('div');
      row.className = 'pending-row';
      const label = document.createElement('div');
      label.textContent = `accept ${p.label} (${p.id})`;
      label.style.overflowWrap = 'anywhere';
      label.style.wordBreak = 'break-all';
      const actions = document.createElement('div');
      actions.className = 'pending-actions';
      const accept = document.createElement('button');
      accept.type = 'button';
      accept.textContent = 'Accept';
      accept.onclick = async () => {
        try {
          await post('/api/friend/accept', {to: p.id});
          await poll();
        } catch (e) { appendInfo(`friend-accept failed: ${e.message}`); }
      };
      const ignore = document.createElement('button');
      ignore.type = 'button';
      ignore.textContent = 'Decline';
      ignore.onclick = async () => {
        try {
          await post('/api/friend/ignore', {to: p.id});
          await poll();
        } catch (e) { appendInfo(`friend-ignore failed: ${e.message}`); }
      };
      actions.appendChild(accept);
      actions.appendChild(ignore);
      row.appendChild(label);
      row.appendChild(actions);
      friendList.appendChild(row);
    }
  }
  if ((targets || []).length === 0) {
    if (pending.length === 0) friendList.textContent = 'No friends/targets yet';
  }
  if (!activeTarget && !activeGroup && (targets || []).length > 0) {
    activeTarget = targets[0].id || '';
    changed = true;
  }
  updateChatContext();
  if (changed) persistContextSoon();
}

function openCreateServerDialog() {
  const name = window.prompt('Server/Group name');
  const group = (name || '').trim();
  if (!group) return;
  post('/api/group/create', {group, channel: 'default', public: true})
    .then(async () => {
      activeGroup = group;
      activeChannel = 'default';
      activeTarget = '';
      updateChatContext();
      await poll();
      persistContextSoon();
    })
    .catch((e) => appendInfo(`group-create failed: ${e.message}`));
}

function openInviteDialog(group, channel) {
  inviteGroup = (group || '').trim();
  inviteChannel = (channel || 'default').trim() || 'default';
  inviteTitle.textContent = `Invite to ${inviteGroup}/${inviteChannel}`;
  inviteList.innerHTML = '';
  const items = (latestTargets || []).filter((t) => t && t.id);
  if (items.length === 0) {
    inviteList.textContent = 'No friends available';
  } else {
    for (const t of items) {
      const row = document.createElement('label');
      row.className = 'chk-row';
      const cb = document.createElement('input');
      cb.type = 'checkbox';
      cb.value = t.id;
      const txt = document.createElement('span');
      txt.textContent = `${t.label} (${t.id})`;
      row.appendChild(cb);
      row.appendChild(txt);
      inviteList.appendChild(row);
    }
  }
  inviteEditor.hidden = false;
}

function renderGroups(groups) {
  latestGroups = Array.isArray(groups) ? groups : [];
  let changed = false;
  groupList.innerHTML = '';
  const items = latestGroups;
  if (items.length === 0) {
    groupList.textContent = 'No servers joined yet';
    channelList.textContent = 'No channels';
    if (activeGroup || activeChannel !== 'default') changed = true;
    activeGroup = '';
    activeChannel = 'default';
    updateChatContext();
    if (changed) persistContextSoon();
    return;
  }
  const exists = items.some((g) => (g.name || '') === activeGroup);
  // Keep DM context stable: only auto-select a group when no DM target is active.
  if (!exists && !activeTarget) {
    activeGroup = items[0].name || '';
    activeChannel = 'default';
    changed = true;
  }
  for (const g of items) {
    const row = document.createElement('div');
    row.className = 'group-row';
    if (activeGroup === (g.name || '')) row.classList.add('sel-row-group');
    row.onclick = () => {
      activeGroup = g.name || '';
      activeChannel = 'default';
      clearUnreadGroupChannel(activeGroup, activeChannel);
      activeTarget = '';
      renderGroups(latestGroups);
      renderChannels();
      updateChatContext();
      persistContextSoon();
    };
    const name = document.createElement('div');
    name.className = 'group-name';
    name.textContent = g.name || '(group)';
    row.appendChild(name);
    const gUnread = unreadCountForGroup(g.name || '');
    if (gUnread > 0) {
      row.appendChild(createUnreadBadge(gUnread));
    }
    const del = document.createElement('button');
    del.type = 'button';
    del.className = 'row-icon-btn';
    del.title = 'Remove';
    del.textContent = '-';
    del.onclick = async (ev) => {
      ev.stopPropagation();
      if (!window.confirm(`Remove server '${g.name || ''}' from this list?`)) return;
      try {
        await post('/api/group/remove', {group: g.name || ''});
        await poll();
        persistContextSoon();
      } catch (e) { appendInfo(`group-remove failed: ${e.message}`); }
    };
    row.appendChild(del);
    groupList.appendChild(row);
  }
  const selected = latestGroups.find((x) => (x.name || '') === activeGroup);
  document.getElementById('channelCreateBtn').hidden = !(selected && selected.owned);
  renderChannels();
  if (changed) persistContextSoon();
}

function renderChannels() {
  channelList.innerHTML = '';
  const g = latestGroups.find((x) => (x.name || '') === activeGroup);
  const channels = g && Array.isArray(g.channels) ? g.channels : [];
  if (!g) {
    channelList.textContent = 'No channels';
    return;
  }
  if (channels.length === 0) {
    channelList.textContent = 'default';
    if (activeChannel !== 'default') persistContextSoon();
    activeChannel = 'default';
    return;
  }
  if (!channels.includes(activeChannel)) {
    activeChannel = channels[0];
    persistContextSoon();
  }
  for (const ch of channels) {
    const row = document.createElement('div');
    row.className = 'group-row';
    if (activeChannel === ch) row.classList.add('sel-row-channel');
    row.onclick = () => {
      activeChannel = ch;
      clearUnreadGroupChannel(activeGroup, activeChannel);
      renderChannels();
      renderGroups(latestGroups);
      updateChatContext();
      persistContextSoon();
    };
    const name = document.createElement('div');
    name.className = 'group-name';
    name.textContent = ch;
    row.appendChild(name);
    const cUnread = Number(unreadGroupChannel[(activeGroup || '') + '/' + ch] || 0);
    if (cUnread > 0) {
      row.appendChild(createUnreadBadge(cUnread));
    }
    const invite = document.createElement('button');
    invite.type = 'button';
    invite.className = 'row-icon-btn';
    invite.title = 'Invite friends';
    invite.textContent = 'Invite';
    invite.onclick = (ev) => {
      ev.stopPropagation();
      openInviteDialog(activeGroup, ch);
    };
    row.appendChild(invite);
    channelList.appendChild(row);
  }
}

async function bootstrap() {
  const res = await fetch('/api/bootstrap');
  const data = await res.json();
  selfLoginID = (data.login_id || '').trim();
  friendsUserName.textContent = data.display_name || '(no nickname)';
  profileIDCopy.innerHTML = '';
  profileIDCopy.appendChild(createCopyIDControl(data.login_id || ''));
  const minTTL = Number(data.presence_ttl_min || 180);
  const maxTTL = Number(data.presence_ttl_max || 900);
  presenceTTL.min = String(minTTL);
  presenceTTL.max = String(maxTTL);
  presenceTTL.value = String(data.presence_ttl_sec || minTTL);
  presenceMode.value = data.presence_visible === false ? 'invisible' : 'visible';
  document.getElementById('displayName').value = data.display_name || '';
  document.getElementById('profileText').value = data.profile_text || '';
  renderTargets(data.targets || [], data.pending_friends || []);
  renderGroups(data.groups || []);
  const last = data.last_context || {};
  if (last.mode === 'group') {
    activeGroup = (last.group || '').trim();
    activeChannel = (last.channel || 'default').trim() || 'default';
    activeTarget = '';
  } else if (last.mode === 'dm') {
    activeTarget = (last.target || '').trim();
    activeGroup = '';
    activeChannel = 'default';
  }
  renderTargets(latestTargets, data.pending_friends || []);
  renderGroups(latestGroups);
  updateChatContext();
  await post('/api/presence/check', {});
}

let lastPresenceCheckAt = 0;
async function poll() {
  try {
    const res = await fetch('/api/events?since=' + since);
    const data = await res.json();
    for (const ev of (data.events || [])) {
      since = Math.max(since, ev.seq || 0);
      if (ev.kind === 'chat') appendChat(ev);
      else appendInfo(`${ev.ts} ${ev.text}`);
    }
    if (data.targets || data.pending_friends) renderTargets(data.targets || [], data.pending_friends || []);
    if (data.groups) renderGroups(data.groups || []);
    const now = Date.now();
    if (now - lastPresenceCheckAt > 15000) {
      lastPresenceCheckAt = now;
      await post('/api/presence/check', {});
    }
  } catch (e) {
    appendInfo(`poll error: ${e.message}`);
  }
}

setInterval(poll, 1000);
bootstrap().then(poll);

document.getElementById('send').onclick = async () => {
  const text = document.getElementById('message').value.trim();
  if (!text) return;
  try {
    if (activeGroup) {
      await post('/api/group/send', {group: activeGroup, channel: activeChannel, text});
    } else {
      const to = currentTarget();
      if (!to) return;
      await post('/api/send', {to, text});
    }
    document.getElementById('message').value = '';
  } catch (e) { appendInfo(`send failed: ${e.message}`); }
};

document.getElementById('message').addEventListener('keydown', async (ev) => {
  if (ev.isComposing) return;
  if (ev.key !== 'Enter') return;
  if (ev.shiftKey) return;
  ev.preventDefault();
  const msgEl = document.getElementById('message');
  const text = msgEl.value.trim();
  if (!text) return;
  try {
    if (activeGroup) {
      await post('/api/group/send', {group: activeGroup, channel: activeChannel, text});
    } else {
      const to = currentTarget();
      if (!to) return;
      await post('/api/send', {to, text});
    }
    msgEl.value = '';
  } catch (e) { appendInfo(`send failed: ${e.message}`); }
});

document.getElementById('friendAdd').onclick = async () => {
  const to = document.getElementById('friendInput').value.trim();
  if (!to) return;
  try {
    await post('/api/friend/add', {to});
    friendEditor.hidden = true;
  } catch (e) { appendInfo(`friend-add failed: ${e.message}`); }
};

document.getElementById('serverCreateBtn').onclick = openCreateServerDialog;

document.getElementById('channelCreateBtn').onclick = async () => {
  if (!activeGroup) return;
  const name = window.prompt(`New channel name for ${activeGroup}`);
  const channel = (name || '').trim();
  if (!channel) return;
  try {
    await post('/api/group/create', {group: activeGroup, channel, public: true});
    activeChannel = channel;
    await poll();
    persistContextSoon();
  } catch (e) { appendInfo(`channel-create failed: ${e.message}`); }
};

document.getElementById('inviteSend').onclick = async () => {
  const checked = Array.from(inviteList.querySelectorAll('input[type="checkbox"]:checked')).map((el) => el.value);
  if (checked.length === 0) return;
  try {
    await post('/api/group/invite', {group: inviteGroup, channel: inviteChannel, to: checked});
    inviteEditor.hidden = true;
  } catch (e) { appendInfo(`group-invite failed: ${e.message}`); }
};

document.getElementById('saveProfile').onclick = async () => {
  const display_name = document.getElementById('displayName').value.trim();
  const profile_text = document.getElementById('profileText').value.trim();
  try {
    await post('/api/profile/set', {display_name, profile_text});
    friendsUserName.textContent = display_name || '(no nickname)';
    profileEditor.hidden = true;
  } catch (e) { appendInfo(`profile save failed: ${e.message}`); }
};

document.getElementById('presenceSave').onclick = async () => {
  const visible = presenceMode.value !== 'invisible';
  const ttlRaw = Number(presenceTTL.value || '0');
  const ttl_sec = Number.isFinite(ttlRaw) ? ttlRaw : 0;
  try {
    const data = await post('/api/presence/set', {visible, ttl_sec});
    if (typeof data.ttl_sec === 'number') presenceTTL.value = String(data.ttl_sec);
  } catch (e) { appendInfo(`presence update failed: ${e.message}`); }
};
</script>
</body>
</html>
